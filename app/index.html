<!DOCTYPE html>
<html>
<body>
    <div id="myApp">
        <h1>Amazon Connect Streams API Samples<h1>
        <h2>Embedding CCP</h2>
    </div>
    <div id="containerDiv" style="width: 320px; min-width: 200px; height: 465px; min-height: 400px; ">
        <!--Amazon CCP will go here-->
    </div>
</body>
</html>
<script src="connect-rtc.js"></script>
<script src="amazon-connect.js"></script>
<script src="https://api.callstats.io/static/callstats.min.js"></script>
<script type="text/javascript">
    var localId;
    var remoteId;
    var appId = "callstatsAppID";
    var appSecret = "appSecret";
    var callstats = new callstats();
    //replace with the CCP URL for your Amazon Connect instance
    var ccpUrl = "https://callstats.awsapps.com/connect/ccp#/";
    var SoftphoneErrorTypes = connect.SoftphoneErrorTypes;
    var pc;

    connect.core.initCCP(containerDiv, {
        ccpUrl: ccpUrl,
        loginPopup: true,
        softphone: {
            allowFramedSoftphone: false
        }
    });
    connect.core.initSoftphoneManager({allowFramedSoftphone: true});
    connect.contact(subscribeToContactEvents);
    connect.agent(subscribeToAgentEvents);

    function subscribeToContactEvents(contact) {
      remoteId = contact.getActiveInitialConnection().getEndpoint().phoneNumber + "";
      if (contact.getActiveInitialConnection()
          && contact.getActiveInitialConnection().getEndpoint()) {
          console.log("New contact is from " + contact.getActiveInitialConnection().getEndpoint().phoneNumber);
      } else {
          console.log("This is an existing contact for this agent");
      }
      contact.onSession(handleSessionCreated);
    }

    function csInitCallback (err, msg){
      console.log("CallStats Initializing Status: err="+err+" msg="+msg);
    }

    function subscribeToAgentEvents(agent) {
      localId = agent.getName();
      agent.onSoftphoneError(handleErrors);
      callstats.initialize(appId, appSecret, localId, csInitCallback);
    }

    function handleErrors(error) {
      if (!error) {
        return;
      }
      var confId = localId + ":" + remoteId;
      if (error.errorType === SoftphoneErrorTypes.MICROPHONE_NOT_SHARED) {
        callstats.reportError(null, confId, callStats.webRTCFunctions.getUserMedia, error);
      } else if (error.errorType === SoftphoneErrorTypes.SIGNALLING_CONNECTION_FAILURE) {
        callstats.reportError(null, confId, callStats.webRTCFunctions.signalingError, error);
      } else if (error.errorType === SoftphoneErrorTypes.SIGNALLING_HANDSHAKE_FAILURE) {
        callstats.reportError(pc, confId, callStats.webRTCFunctions.setLocalDescription, error);
      } else if (error.errorType === SoftphoneErrorTypes.ICE_COLLECTION_TIMEOUT) {
        callstats.reportError(pc, confId, callStats.webRTCFunctions.iceConnectionFailure, error);
      }
    }

    function handleSessionCreated(session) {
      var confId = localId + ":" + remoteId;
      pc = session._pc;
      var ret = callstats.addNewFabric(pc, remoteId, callstats.fabricUsage.multiplex, confId);
    }
</script>
